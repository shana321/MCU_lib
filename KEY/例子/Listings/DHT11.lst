C51 COMPILER V9.54   DHT11                                                                 02/24/2018 18:17:44 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE DHT11
OBJECT MODULE PLACED IN .\Objects\DHT11.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE DHT11.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\DHT
                    -11.lst) TABS(2) OBJECT(.\Objects\DHT11.obj)

line level    source

   1          #include "DHT11.h"
   2          
   3          void dht11_Init(DHT11_t *dht,dht11_msg_cb dht_cb)
   4          {
   5   1        dht->gpio_and_delay_cb = dht_cb;
   6   1        dht->gpio_and_delay_cb(dht,DHT11_MSG_SDA_HIGH);
   7   1        dht->gpio_and_delay_cb(dht,DHT11_MSG_2S_DELAY);//保证上电2S越过dht11不稳定状态
   8   1      }
   9          uint8_t dht11_Read(DHT11_t *dht)
  10          {
  11   1        uint8_t i,j,sum;
  12   1        dht->DHT11_RXD_Buff[0] = dht->DHT11_RXD_Buff[1] = dht->DHT11_RXD_Buff[2] = dht->DHT11_RXD_Buff[3] = dht->
             -DHT11_RXD_Buff[4] = 0;
  13   1        dht->gpio_and_delay_cb(dht,DHT11_MSG_SDA_HIGH);//拉高总线
  14   1        dht->gpio_and_delay_cb(dht,DHT11_MSG_1MS_DELAY);//延时1ms
  15   1        dht->gpio_and_delay_cb(dht,DHT11_MSG_SDA_LOW);//拉低
  16   1        
  17   1        dht->gpio_and_delay_cb(dht,DHT11_MSG_18MS_DELAY);//延时18ms
  18   1      
  19   1        
  20   1        dht->gpio_and_delay_cb(dht,DHT11_MSG_SDA_HIGH);//然后拉高
  21   1        dht->gpio_and_delay_cb(dht,DHT11_MSG_30US_DELAY);//等待30us
  22   1          //做完一个起始信号，等待从机拉低
  23   1        if(dht->gpio_and_delay_cb(dht,DHT11_MSG_READ_SDA) == 0)//读到的是低电平，从机响应了，那么等待其变高后准备
             -接收数据
  24   1        {
  25   2          while(!dht->gpio_and_delay_cb(dht,DHT11_MSG_READ_SDA));//等待低电平结束
  26   2        }
  27   1        else
  28   1        {
  29   2          return 1;//直接返回，避免下面等待高电平陷入死循环
  30   2        }
  31   1        while(dht->gpio_and_delay_cb(dht,DHT11_MSG_READ_SDA));//等待80us的高电平结束，然后开始接收
  32   1        
  33   1        for(j=0;j<5;j++)
  34   1        {
  35   2          for(i=0;i<8;i++)
  36   2          {
  37   3            while(!dht->gpio_and_delay_cb(dht,DHT11_MSG_READ_SDA));//等待50us左右的低电平结束
  38   3            dht->DHT11_RXD_Buff[j] <<=1;
  39   3            dht->gpio_and_delay_cb(dht,DHT11_MSG_30US_DELAY);//延时1ms
  40   3            if(dht->gpio_and_delay_cb(dht,DHT11_MSG_READ_SDA))
  41   3            {
  42   4              dht->DHT11_RXD_Buff[j] |= 0x01;
  43   4              while(dht->gpio_and_delay_cb(dht,DHT11_MSG_READ_SDA));//等待高电平结束
  44   4            }
  45   3          }
  46   2        }
  47   1        
  48   1        sum = dht->DHT11_RXD_Buff[0] + dht->DHT11_RXD_Buff[1] + dht->DHT11_RXD_Buff[2] + dht->DHT11_RXD_Buff[3];
  49   1        
  50   1        if(sum != dht->DHT11_RXD_Buff[4] || sum == 0) return 1;//检查校验和
  51   1        
  52   1        return 0;
C51 COMPILER V9.54   DHT11                                                                 02/24/2018 18:17:44 PAGE 2   

  53   1      }
  54          uint8_t DHT11_Fget(DHT11_t *dht,float *Humi,float *Temp)
  55          {
  56   1        
  57   1        uint16_t t = 0x0000;
  58   1        uint8_t sum = 0;
  59   1        sum = dht->DHT11_RXD_Buff[0] + dht->DHT11_RXD_Buff[1] + dht->DHT11_RXD_Buff[2] + dht->DHT11_RXD_Buff[3];
  60   1        
  61   1        if(sum != dht->DHT11_RXD_Buff[4] || sum == 0) return 1;//检查校验和
  62   1        t |= dht->DHT11_RXD_Buff[0];
  63   1        
  64   1        *Humi = (float)t;
  65   1        
  66   1        t = 0x0000;
  67   1        
  68   1        t = dht->DHT11_RXD_Buff[2];
  69   1      
  70   1        *Temp = (float)t;
  71   1        return 0;
  72   1      }
  73          uint8_t DHT11_Iget(DHT11_t *dht,int16_t *Humi,int16_t *Temp)
  74          {
  75   1        
  76   1        int16_t t = 0x0000;
  77   1        uint8_t sum = 0;
  78   1        sum = dht->DHT11_RXD_Buff[0] + dht->DHT11_RXD_Buff[1] + dht->DHT11_RXD_Buff[2] + dht->DHT11_RXD_Buff[3];
  79   1        
  80   1        if(sum != dht->DHT11_RXD_Buff[4] || sum == 0) return 1;//检查校验和
  81   1        
  82   1        t |= dht->DHT11_RXD_Buff[0];
  83   1        //t <<= 8;
  84   1        //t |= dht->dht11_RXD_Buff[1];
  85   1        
  86   1        *Humi = (int16_t)t;
  87   1        
  88   1        t = 0x0000;
  89   1        
  90   1        t = dht->DHT11_RXD_Buff[2];
  91   1      
  92   1      
  93   1        *Temp = (int16_t)t;
  94   1        return 0;
  95   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    923    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      29
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
